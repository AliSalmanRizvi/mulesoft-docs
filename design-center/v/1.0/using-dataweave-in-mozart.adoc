= Using DataWeave in Mozart
:keywords:


== Overview


In the *Transform* card, you can dynamically generate mappings through DataWeave, MuleSoft's most powerful and versatile tool for transforming data. The Transform card carries out a transformation of your Mule message that follows a transform script, this script is implicitly built through dragging and dropping elements using a simple interface. You also have access to the mapping's code, in case you want to edit it by link:/mule-user-guide/v/3.8/dataweave-language-introduction[explicitly writing in DataWeave code].

The *Transform Message* component offers you an output preview that is built on sample data you provide. This preview is updated in real time as you make changes to your script or to your sample, so that you can be sure of what you'll be getting out of the other end.


[TIP]
====
The *transform* card generates scripts in DataWeave language. You can unleash the full power of this language by writing scripts directly in the text editor, to learn about its possibilities and syntax see link:/mule-user-guide/v/3.8/dataweave-language-introduction[DataWeave language Introduction].
====

When adding a *Transform Message* element to a Mule Flow, it takes the elements from the incoming Mule Message as its inputs. It then performs the necessary actions to produce a Mule message as output, which is then passed on to the next element in the flow.

If you click on an instance of the Transform Message element in your flow, its properties editor are displayed:

image:[new weave]

In the default view, the properties editor of the *Transform Message* element displays two main regions:

* *On the left*: is the graphical UI, which exposes the known input and output structures. The mappings between input and output fields are represented through lines and regions that draw both ends together. You can easily click and drag one field onto another to map them together and draw a line between them. Other ways to interact with this UI are described below.
* *On the right*: Is the output preview. Here you can see what your output data would look like after being affected by the transformation script that's created through your interactions with the UI. This output is constructed based on sample data, which can be obtained from the metadata exposed by other elements on the flow, or can otherwise be manually provided.

Note that in the lower margin of the editor, there are three tabs you can click to select the view:

* the *Mappings* view is the default view described above, which lets you drag and drop via the UI to create transformations
* the *Sample Data* view allows you to provide sample data, which is processed in real time to produce an output preview
* the *Source* view displays the DataWeave code that describes the transformation carried out by this card. By editing the code drectly you can leverage the full power of DataWeave syntax, which includes many tools that allow you to aggregate, normalize, group, join, partition, pivot and filter. See the link:/mule-user-guide/v/3.8/dataweave-language-introduction[DataWeave language introduction] for a guide on the DataWeave language syntax.

== Populating Metadata

getting the metadata
how to populate it


== The Mappings View

image:[ui]


[TIP]
When creating a new transformation, it's a lot easier if you first add and configure any other elements on your flow that expose metadata. In this way, this metadata that other message processors expose to Studio is displayed in the input and output structures, without you needing to define the metadata explicitly.

This is the default view that is displayed when you open this card. Through this view, you can easily map input fields onto output fields through intuitive simple interactions. Two tree views show the known metadata contents of the incoming and the outgoing Mule Messages, allowing you to explore them and know what data is available for using as an input and where it can fit into.

Here some of the most common things you can do through the UI:

* Simple mappings of one field onto another are represented by arrows. You can easily create these by clicking and dragging an input element and releasing it on the corresponding output element.

image:
* Drag an element on the input structure over to another on the output structure. This will cast a line that joins them in the UI, representing that when your transformation is executed, the output field takes the value of the input field.
+
image:

* Drag a high-level object that contains child elements onto another in the output. This mapping is be represented by a shaded region, and when your transformation is executed, all child elements in the input are passed on to the output.
+
image:[complex object drag]

* Double click on an output field to edit it. You can assign it a static value, or write a function that might involve one or more of the input fields. To populate a field with a function, just double click on it and write freely. This experience relates to that of using a spreadsheet, where each field can have a function behind it. When a function or static value exists on a field, this is represented by an `f(x)` icon next to it.
+
image:[click]
* Filter the views displayed in the input and output structures by typing a name in the search boxes at the top of either, only those fields that match your search are then displayed. This is particularly useful when dealing with large data structures with many nested elements.


(not sure last one exists here)



== The Sample Data View

Once you have defined the input structure, you can create a sample populated with test data based on that sample.

This sample data is used together with your DataWeave code to produce a sample output in <<the preview section>>, which gets updated in real time as you make changes.

You can access this tab by right clicking on the root of the input section and selecting *Edit Sample Data*.

image:[sample data]

[TIP]
This same menu can also be accessed by opening the <<The Preview Section, preview section>>, which will display a shortcut to set this up in case it's still not provided.

[NOTE]
When the input is of types JSON, XML, CSV or flat file, the sample input contains plain code in the corresponding format. When the input is of type POJO or DataWeave, the sample input is written in DataWeave for more simplicity. In these cases the sample DataWeave code is merely a way to display the sample data, not a transformation in itself.

Selecting this option opens a new tab in the input section with an empty scaffolding of your input structure, in which values are populated with the string `????`. You can replace these values with more useful sample values to see how they are mapped out to the preview section.

image:[sample data]


[TIP]
====
You can always click the *rescafold button* to restore the sample data to its default state. Note that with this you'll loose any sample data you've provided.

image:[rescafold]
====



== The Source View

image:[code]

In this section, you write the actual link:/mule-user-guide/v/3.8/dataweave-language-introduction[DataWeave] code that carries out the transform. Sometimes, all you need to do can be automatically built by dragging elements in the GUI, but other times you may want to carry out more complex operations that involve aggregation, filtering, calculations, defining custom functions, etc... and for that you must write DataWeave code.

=== Directives in Studio

The header of a dataweave script defines directives that indicate the input, the output and constant values or functions that can be referenced anywhere in the code. See link:/mule-user-guide/v/3.8/dataweave-language-introduction#the-dataweave-header[The DataWeave Header]. These directives can be manually set on the code, or automatically defined based on the metadata on your flow or what you map in the UI.

If your transform outputs XML data, a namespace directive will be automatically added to your DataWeave header section, defining a default name for it. This namespace is then referenced in the body too.

----
%dw 1.0
%output application/xml
%namespace ns0 http://mulesoft.org/tshirt-service
----

[NOTE]
Although DataWeave as a language supports adding input directives and naming these by any name you like, when using DataWeave in Anypoint Studio, it's not necessary to declare any input directives for any of the components of the Mule Message that arrives to the DataWeave transformer (Payload, flow variables and input/outbound properties) nor for any system variables. These are already implicitly recognized as inputs and can be referenced anywhere in the DataWeave body without a need to include them in the header, their type is known from Mule metadata.


For further reference about writing DataWeave code, see link:/mule-user-guide/v/3.8/dataweave-language-introduction[DataWeave Language Introduction]


== The Preview Section

You can enable the preview section by clicking on the *Preview* button on the top-right of the editor.

image:[buttons]

This section presents a sample output, built by taking the sample input you provide and transforming it through the DataWeave transform. As you make changes in the DataWeave code, notice how the output data structure changes.  If your transformer has <<handling multiple outputs, multiple outputs>>, the *Preview* section will display the one corresponding to the currently selected transform.

image:[preview]

If no sample is provided yet, this section features a shortcut that you can click to open the <<provide input sample data,*Edit Sample*>> window and provide an input sample to construct the preview.

image:[shortuct]

If you still haven't set up the metadata structure for your input, when clicking on this shortcut you will be first prompted to set up the structure via the <<Defining Input and Output Structure>> window.


== Viewing Errors

For your DataWeave code's syntax to be evaluated, you must have the *Preview Section* enabled. With this enabled, any syntax errors are marked. Above your DataWeave code, an additional error notification can be opened to display further detail.

+
image:[errors]
If you click this notification, a window opens detailing each error in your code and its cause.

+
image:[errors]



















== Defining Input and Output Structure


You can simplify or hide the graphical UI if you wish by clicking the icons on the top right to select between the different views for this properties editor:

image:dw_buttons.png[buttons]

If other elements in your Mule flow expose metadata about their input and output, then this information should already be available to the *Transform Message* component and the UI section should display it.

If the metadata definition is missing for the input or output, a notification on the corresponding section of the Graphical UI will advise you to provide it, click the *Define Metadata* link.

[TIP]
This same menu can also be accessed by opening the <<The Preview Section, preview section>>, which will display a shortcut to set this up in case it's still not configured.

If they don't, you can configure the *Metadata tab* of other elements in your flow, see link:/anypoint-studio/v/6/defining-metadata[Defining Metadata]. Otherwise, you can also specify this metadata on the *input or output section of your Transform Message component*. Simply right-click on the root of the corresponding section of the Graphical Ui and select *Set Metadata* to access the same options.

[TIP]
====
If you plan to create your transform entirely via the <<The DataWeave Text Editor, text editor section>>, you can skip specifying the metadata definition and directly set an output type in the link:/mule-user-guide/v/3.8/dataweave-language-introduction#output-directive[output directive] of your DataWeave code.

To define your metadata via XML, see link:/mule-user-guide/v/3.8/dataweave-xml-reference#defining-metadata-via-xml[DataWeave XML Reference].
====


== Reader Configuration

Some input formats allow you to define a reader with specific properties that make DataWeave parse inputs differently. In Anypoint Studio, there are two ways to set this up:

* Configure the component of your Mule flow that actually brings this information in, by accessing its link:/mule-user-guide/v/3.8/custom-metadata-tab[*Metadata* tab].

* On the Transform Message component itself, right clicking on the root of the input section and selecting *Reader Configuration* to access a menu
+
image:dw_reader_configuration_select.png[reader conf]

+
[NOTE]
This option won't be available if the type of the input doesn't allow for this kind of configuration. If the payload is of type `unknown`, you must change its type first.

You can also add this information through properties in the XML source of your Mule project. For this, see link:/mule-user-guide/v/3.8/dataweave-xml-reference#reader-proerties[DataWeave XML reference]




For a detailed reference of what properties can be set in the Reader Configuration of each format, see the corresponding *reader properties* section:

* link:/mule-user-guide/v/3.8/dataweave-formats#csv[CSV]

* link:/mule-user-guide/v/3.8/dataweave-formats#xml[XML]

* link:/mule-user-guide/v/3.8/dataweave-formats#flat-file[Flat File]

== Writer Configuration

Some output formats allow you to define a writer with specific properties, these make DataWeave construct the output with a different syntax.

These properties are simply written on the `%output` directive of your DataWeave code.

For a detailed reference of what properties can be set in the Writer Configuration of each format, see the corresponding *reader properties* section:

* link:/mule-user-guide/v/3.8/dataweave-formats#csv[CSV]

* link:/mule-user-guide/v/3.8/dataweave-formats#xml[XML]

* link:/mule-user-guide/v/3.8/dataweave-formats#json[JSON]

* link:/mule-user-guide/v/3.8/dataweave-formats#flat-file[Flat File]


== Handling Multiple Outputs

A single Transform Message element can give shape to several different components of the output Mule message. Each of these output components must be defined in a separate `.dwl` file, written out in a separate tab of the Transform section. For example in one tab you may be defining the payload contents, in another those of an outbound property, and these will both be parts of the same output Mule message.

To add a new output, simply click the *Add new target* button at the top of the DataWeave code section.


image:dw_multiple_outputs_first.png[multiple outputs]

Then you must specify where in the output Mule message to place the output of this new DataWeave transform. In case you're creating a new variable or property, you must also set a name for it.


image:dw_new_variable.png[new variable]



You can also change the target of an existing transform by clicking the *Edit Current Target* button, and in that way point the output of your transform to a different element in the outgoing Mule Message.

image:dw_multiple_outputs_edit.png[edit target]
